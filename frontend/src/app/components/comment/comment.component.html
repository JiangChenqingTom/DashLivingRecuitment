<div class="comments-section">
    <!-- Comments list -->
    <div class="comments-list">
        <ng-template #commentTemplate let-comment let-level="level">
            <div class="comment" [style.margin-left.px]="level * 20">
                <div class="comment-header">
                    <span class="author">{{ comment.username }}</span>
                    <span class="date">{{ comment.createdAt | date:'medium' }}</span>
                </div>
                <div class="comment-content">
                    {{ comment.content }}
                </div>
                <div class="comment-actions" *ngIf="isLoggedIn">
                    <button class="btn btn-link btn-sm" (click)="startReply(comment.id)" *ngIf="replyingTo !== comment.id">
                        Reply
                    </button>
                </div>
                
                <!-- Reply form -->
                <div class="reply-form" *ngIf="replyingTo === comment.id">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               [formControl]="commentContent" 
                               placeholder="Write a reply..."
                               (keyup.enter)="submitComment(comment.id)">
                        <button class="btn btn-primary btn-sm" 
                                (click)="submitComment(comment.id)" 
                                [disabled]="!commentContent.value?.trim()">
                            Reply
                        </button>
                        <button class="btn btn-secondary btn-sm" 
                                (click)="cancelReply()">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Nested replies -->
                <div class="replies" *ngIf="comment.replies && comment.replies.length > 0">
                    <ng-container *ngFor="let reply of comment.replies">
                        <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: reply, level: level + 1 }">
                        </ng-container>
                    </ng-container>
                </div>
            </div>
        </ng-template>

        <ng-container *ngFor="let comment of comments">
            <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: comment, level: 0 }">
            </ng-container>
        </ng-container>

        <div *ngIf="comments.length === 0" class="text-muted text-center py-2">
            No comments yet
        </div>
    </div>
    
    <!-- Top-level comment form for logged in users -->
    <div class="comment-form mt-3" *ngIf="isLoggedIn && !replyingTo">
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   [formControl]="commentContent" 
                   placeholder="Write a comment..."
                   (keyup.enter)="submitComment()">
            <button class="btn btn-primary" 
                    (click)="submitComment()" 
                    [disabled]="!commentContent.value?.trim()">
                Comment
            </button>
        </div>
    </div>

    <!-- Login prompt for non-logged in users -->
    <div *ngIf="!isLoggedIn" class="mt-3">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            Please <a routerLink="/login" class="alert-link">login</a> to comment
        </div>
    </div>
</div>
